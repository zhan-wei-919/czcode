groups:
  - name: czcode-java-services
    rules:
      - alert: CzCodeJavaServiceDown
        expr: up{job=~"auth-service|project-service|user-service"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service down: {{ $labels.job }}"
          description: "No scrape data for {{ $labels.job }} in last 2 minutes."

      - alert: CzCodeJavaHigh5xxRate
        expr: |
          (
            sum by (application) (rate(http_server_requests_seconds_count{application=~"auth-service|project-service|user-service",status=~"5.."}[5m]))
            /
            clamp_min(sum by (application) (rate(http_server_requests_seconds_count{application=~"auth-service|project-service|user-service"}[5m])), 1)
          ) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx rate: {{ $labels.application }}"
          description: "5xx ratio > 5% for 5m on {{ $labels.application }}."

      - alert: CzCodeJavaHighP95Latency
        expr: |
          histogram_quantile(
            0.95,
            sum by (application, le) (
              rate(http_server_requests_seconds_bucket{application=~"auth-service|project-service|user-service"}[5m])
            )
          ) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High p95 latency: {{ $labels.application }}"
          description: "p95 latency > 1s for 10m on {{ $labels.application }}."

      - alert: CzCodeJavaHikariPoolHighUsage
        expr: |
          (
            hikaricp_connections_active{application=~"auth-service|project-service|user-service"}
            /
            clamp_min(hikaricp_connections_max{application=~"auth-service|project-service|user-service"}, 1)
          ) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Hikari pool high usage: {{ $labels.application }}"
          description: "Active DB connections > 80% for 10m on {{ $labels.application }}."

      - alert: CzCodeJavaApiRateLimitSpike
        expr: |
          sum by (service) (
            increase(czcode_api_ratelimit_blocked_total{service=~"auth-service|project-service|user-service"}[5m])
          ) > 200
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API rate-limit spike: {{ $labels.service }}"
          description: "Rate-limited requests exceeded 200 in 5m on {{ $labels.service }}."
